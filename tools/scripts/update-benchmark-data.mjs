#!/usr/bin/env node
/**
 * Fetches benchmark_result.json from a GitHub release and generates the TypeScript
 * version file for the benchmark dashboard. Used by the update-benchmark-data workflow.
 *
 * Usage: node tools/scripts/update-benchmark-data.mjs <version>
 * Example: node tools/scripts/update-benchmark-data.mjs 1.7.0
 */

import { writeFileSync, readFileSync, existsSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const ROOT = join(__dirname, '../..');

function toMicroseconds(ms) {
  return Math.round(ms * 1000);
}

function transformResult(r, version) {
  const upstreamConnections = r.upstreamConnections ?? r.upstreamConnection ?? 0;
  const latency = r.latency;

  const result = {
    testName: r.testName,
    routes: r.routes,
    routesPerHostname: r.routesPerHostname,
    phase: r.phase,
    throughput: r.throughput,
    totalRequests: r.totalRequests,
    latency: latency
      ? {
          min: toMicroseconds(latency.min),
          mean: toMicroseconds(latency.mean),
          max: toMicroseconds(latency.max),
          pstdev: toMicroseconds(latency.pstdev),
          percentiles: {
            p50: toMicroseconds(latency.percentiles.p50),
            p75: toMicroseconds(latency.percentiles.p75),
            p80: toMicroseconds(latency.percentiles.p80),
            p90: toMicroseconds(latency.percentiles.p90),
            p95: toMicroseconds(latency.percentiles.p95),
            p99: toMicroseconds(latency.percentiles.p99),
            p999: toMicroseconds(latency.percentiles.p999)
          }
        }
      : {
          min: 0,
          mean: 0,
          max: 0,
          pstdev: 0,
          percentiles: { p50: 0, p75: 0, p80: 0, p90: 0, p95: 0, p99: 0, p999: 0 }
        },
    resources: {
      envoyGateway: {
        memory: r.resources?.envoyGateway?.memory || { min: 0, max: 0, mean: 0 },
        cpu: r.resources?.envoyGateway?.cpu || { min: 0, max: 0, mean: 0 }
      },
      envoyProxy: {
        memory: r.resources?.envoyProxy?.memory || { min: 0, max: 0, mean: 0 },
        cpu: r.resources?.envoyProxy?.cpu || { min: 0, max: 0, mean: 0 }
      }
    },
    poolOverflow: r.poolOverflow ?? 0,
    upstreamConnections
  };

  if (r.counters && Object.keys(r.counters).length > 0) {
    result.counters = r.counters;
  }

  return result;
}

function generateVersionFile(testSuite) {
  const version = testSuite.metadata.version;
  const json = JSON.stringify(testSuite, null, 2);
  return `import { TestSuite } from '../types';

// Benchmark data from release artifact for version ${version}
// Generated by update-benchmark-data workflow on ${new Date().toISOString()}

export const benchmarkData: TestSuite = ${json};

export default benchmarkData;
`;
}

function updateIndex(version) {
  const indexPath = join(ROOT, 'site/tools/benchmark-dashboard/src/data/index.ts');
  let content = readFileSync(indexPath, 'utf8');

  const varName = `v${version.replace(/\./g, '')}TestSuite`;
  const importLine = `import { benchmarkData as ${varName} } from './versions/v${version}';`;

  if (content.includes(`from './versions/v${version}'`)) {
    console.log(`Version ${version} already in index.ts`);
    return;
  }

  // Add import after the first version import (newest first in file)
  const firstVersionImport = content.match(/import \{ benchmarkData as v\d+TestSuite \} from '\.\/versions\/v[\d.]+';\n/);
  if (firstVersionImport) {
    content = content.replace(
      firstVersionImport[0],
      `${firstVersionImport[0]}${importLine}\n`
    );
  }

  // Add to allTestSuites array at the beginning (newest first)
  content = content.replace(
    /export const allTestSuites: TestSuite\[\] = \[\n  (v\d+TestSuite),/,
    `export const allTestSuites: TestSuite[] = [\n  ${varName},\n  $1,`
  );

  writeFileSync(indexPath, content);
  console.log(`Updated index.ts with ${version}`);
}

async function main() {
  const version = process.argv[2];
  if (!version || !/^\d+\.\d+\.\d+$/.test(version)) {
    console.error('Usage: node update-benchmark-data.mjs <version>');
    console.error('Example: node update-benchmark-data.mjs 1.7.0');
    process.exit(1);
  }

  const url = `https://github.com/envoyproxy/gateway/releases/download/v${version}/benchmark_result.json`;
  console.log(`Fetching ${url}...`);

  const response = await fetch(url);
  if (!response.ok) {
    console.error(`Failed to fetch: ${response.status} ${response.statusText}`);
    process.exit(1);
  }

  const rawJson = await response.json();
  const tc = rawJson.metadata?.testConfiguration || {};
  const testConfiguration = {
    rps: parseInt(tc.rps || '10000', 10),
    connections: parseInt(tc.connections || '100', 10),
    duration: parseInt(tc.duration || '30', 10),
    cpuLimit: tc.cpu || '1000m',
    memoryLimit: tc.memory || '2000Mi'
  };

  const results = (rawJson.results || []).map((r) => transformResult(r, version));

  const testSuite = {
    metadata: {
      version,
      runId: `${version}-${Date.now()}`,
      date: new Date().toISOString(),
      environment: 'GitHub CI',
      description: `Benchmark results for version ${version}`,
      testConfiguration,
      downloadUrl: `https://github.com/envoyproxy/gateway/releases/download/v${version}/benchmark_report.zip`
    },
    results
  };

  const versionsDir = join(ROOT, 'site/tools/benchmark-dashboard/src/data/versions');
  const versionFile = join(versionsDir, `v${version}.ts`);
  const content = generateVersionFile(testSuite);

  writeFileSync(versionFile, content);
  console.log(`Wrote ${versionFile}`);

  updateIndex(version);
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
